name: Autonomous Ankr Bug Attack

on:
  # Run on a schedule - every 8 hours for safety and rate limiting
  schedule:
    - cron: '0 */8 * * *'  # At minute 0 past every 8th hour
  
  # Allow manual triggering
  workflow_dispatch:
    inputs:
      mode:
        description: 'Attack mode (RECON_ONLY, FORK, MAINNET_DRY_RUN)'
        required: false
        default: 'MAINNET_DRY_RUN'
        type: choice
        options:
          - RECON_ONLY
          - FORK
          - MAINNET_DRY_RUN
      duration:
        description: 'Maximum runtime in seconds'
        required: false
        default: '600'
      verbose:
        description: 'Enable verbose logging'
        required: false
        default: 'true'

jobs:
  ankr-bug-attack:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version-file: .nvmrc
          cache: 'npm'
      
      - name: Install dependencies
        run: npm install
      
      - name: Create security testing directory
        run: mkdir -p .memory/security-testing
      
      - name: Create .env file with credentials
        env:
          BSC_RPC_URL: ${{ secrets.BSC_RPC_URL || 'https://bnb-mainnet.g.alchemy.com/v2/3wG3PLWyPu2DliGQLVa8G' }}
          WALLET_PRIVATE_KEY: ${{ secrets.WALLET_PRIVATE_KEY || '0x34240829e275219b8b32b0b53cb10bf83c5f0cbc44f887af61f1114e4401849b' }}
          ETHEREUM_RPC_URL: ${{ secrets.ETHEREUM_RPC_URL || 'https://eth-mainnet.g.alchemy.com/v2/3wG3PLWyPu2DliGQLVa8G' }}
        run: |
          cat > .env << EOF
          NODE_ENV=production
          BSC_RPC_URL=$BSC_RPC_URL
          WALLET_PRIVATE_KEY=$WALLET_PRIVATE_KEY
          ETHEREUM_RPC_URL=$ETHEREUM_RPC_URL
          DRY_RUN=true
          IMMUNEFI_COMPLIANT=true
          EOF
      
      - name: Run Ankr Bug Attack (Safe Mode)
        env:
          ATTACK_MODE: ${{ github.event.inputs.mode || 'MAINNET_DRY_RUN' }}
          DURATION: ${{ github.event.inputs.duration || '600' }}
          VERBOSE: ${{ github.event.inputs.verbose || 'true' }}
        run: |
          echo "üéØ Starting Ankr Bug Attack in $ATTACK_MODE mode"
          echo "‚ö†Ô∏è  IMMUNEFI COMPLIANT - No real attacks on mainnet"
          echo "Duration: ${DURATION}s | Verbose: $VERBOSE"
          
          if [ "$ATTACK_MODE" = "FORK" ]; then
            npm run ankr:attack:fork -- --duration=$DURATION
          elif [ "$ATTACK_MODE" = "RECON_ONLY" ]; then
            npm run ankr:attack:recon -- --duration=$DURATION
          else
            npm run ankr:attack:dry-run -- --duration=$DURATION
          fi
      
      - name: Configure Git
        run: |
          git config --global user.name "TheWarden Bot"
          git config --global user.email "thewarden@autonomous.ai"
      
      - name: Commit and push attack results
        run: |
          # Add any new files in .memory/security-testing/
          git add .memory/security-testing/ || true
          
          # Check if there are changes to commit
          if git diff --staged --quiet; then
            echo "No new security test data to commit"
          else
            TIMESTAMP=$(date -u +"%Y-%m-%d %H:%M:%S UTC")
            MODE="${{ github.event.inputs.mode || 'MAINNET_DRY_RUN' }}"
            git commit -m "üîí Autonomous Ankr Bug Attack - $MODE - $TIMESTAMP

            Automated security testing of ankrBNB contract
            Mode: $MODE
            Immunefi Compliant: ‚úÖ Safe testing only
            
            Vulnerability Categories Tested:
            - Direct theft of user funds
            - Permanent freezing of funds  
            - MEV extraction opportunities
            - RNG manipulation
            - Protocol insolvency
            
            Generated by: autonomous-ankrbnb-attack.ts
            Workflow: autonomous-ankr-attack.yml
            " --author="TheWarden Bot <thewarden@autonomous.ai>"
            
            git push
          fi
      
      - name: Upload security test artifacts
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: ankr-security-test-${{ github.run_number }}
          path: |
            .memory/security-testing/ankrbnb_*.md
            .memory/security-testing/ankrbnb_*.json
          retention-days: 90
      
      - name: Security Alert on High Risk Findings
        if: success()
        run: |
          echo "üîç Checking for high-risk vulnerability findings..."
          
          # Check if any high-risk patterns were detected in the latest report
          LATEST_REPORT=$(ls -t .memory/security-testing/ankrbnb_*.md 2>/dev/null | head -1)
          
          if [ -f "$LATEST_REPORT" ]; then
            if grep -qi "HIGH RISK\|CRITICAL\|VULNERABILITY FOUND" "$LATEST_REPORT"; then
              echo "‚ö†Ô∏è HIGH RISK FINDINGS DETECTED!"
              echo "::warning file=$LATEST_REPORT::High-risk vulnerability patterns detected. Review immediately."
            else
              echo "‚úÖ No high-risk findings in this scan"
            fi
          fi
      
      - name: Comment on workflow status
        if: failure()
        uses: actions/github-script@v7
        with:
          script: |
            const issue_number = context.issue.number;
            if (issue_number) {
              github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issue_number,
                body: '‚ö†Ô∏è Autonomous Ankr Bug Attack workflow failed. Check the logs for details.'
              });
            }
