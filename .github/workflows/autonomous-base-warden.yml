name: Autonomous Base Network - TheWarden

on:
  # Run on a schedule - every hour for active arbitrage monitoring
  schedule:
    - cron: '0 * * * *'  # At the start of every hour
  
  # Allow manual triggering for on-demand runs
  workflow_dispatch:
    inputs:
      duration:
        description: 'Runtime duration in seconds'
        required: false
        default: '3600'
        type: string
      dry_run:
        description: 'Dry run mode (true = no real transactions)'
        required: false
        default: 'true'
        type: choice
        options:
          - 'true'
          - 'false'
      scan_interval:
        description: 'Scan interval in milliseconds'
        required: false
        default: '800'
        type: string

jobs:
  base-network-arbitrage:
    runs-on: ubuntu-latest
    
    permissions:
      contents: write        # Commit and push results
      actions: read          # Read workflow artifacts
      issues: write          # Create/update issues for findings
      statuses: write        # Update commit statuses
      
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version-file: .nvmrc
          cache: 'npm'
      
      - name: Install dependencies
        run: npm install
      
      - name: Create necessary directories
        run: |
          mkdir -p logs
          mkdir -p .memory/autonomous-execution
      
      - name: Create .env file with Base network configuration
        env:
          BASE_RPC_URL: ${{ secrets.BASE_RPC_URL }}
          WALLET_PRIVATE_KEY: ${{ secrets.WALLET_PRIVATE_KEY }}
          ALCHEMY_API_KEY: ${{ secrets.ALCHEMY_API_KEY }}
        run: |
          # Validate required secrets are set
          if [ -z "$BASE_RPC_URL" ]; then
            echo "::error::BASE_RPC_URL secret is not set. Please configure it in repository secrets."
            echo "Get a free RPC URL from: https://www.alchemy.com/ or https://base.org/docs/tools/node-providers"
            exit 1
          fi
          if [ -z "$WALLET_PRIVATE_KEY" ]; then
            echo "::error::WALLET_PRIVATE_KEY secret is not set. Please configure it in repository secrets."
            exit 1
          fi
          
          # Determine dry run mode
          DRY_RUN="${{ github.event.inputs.dry_run || 'true' }}"
          SCAN_INTERVAL="${{ github.event.inputs.scan_interval || '800' }}"
          
          # Create .env file with Base network configuration
          cat > .env << EOF
          # === Core Configuration ===
          NODE_ENV=production
          CHAIN_ID=8453
          DRY_RUN=$DRY_RUN
          
          # === Base Network RPC ===
          BASE_RPC_URL=$BASE_RPC_URL
          RPC_URL=$BASE_RPC_URL
          
          # === Wallet Configuration ===
          WALLET_PRIVATE_KEY=$WALLET_PRIVATE_KEY
          
          # === Performance Configuration ===
          SCAN_INTERVAL=$SCAN_INTERVAL
          MIN_PROFIT_THRESHOLD=0.15
          MIN_PROFIT_PERCENT=0.3
          MIN_PROFIT_ABSOLUTE=0.001
          
          # === DEX Configuration ===
          ENABLE_UNISWAP_V2=true
          ENABLE_UNISWAP_V3=true
          ENABLE_AERODROME=true
          ENABLE_BASESWAP=true
          
          # === Safety Systems ===
          CIRCUIT_BREAKER_ENABLED=true
          CIRCUIT_BREAKER_MAX_CONSECUTIVE_FAILURES=5
          EMERGENCY_STOP_ENABLED=true
          
          # === Logging ===
          LOG_LEVEL=info
          ENABLE_LOGGING=true
          LOG_DIR=./logs
          
          # === Memory & Consciousness ===
          MEMORY_BACKGROUND_ENABLED=true
          COGNITIVE_CONSENSUS_THRESHOLD=0.65
          
          # === Feature Flags ===
          ENABLE_DASHBOARD=false
          ENABLE_SSE_SERVER=false
          EOF
          
          echo "âœ… Configuration created for Base network"
          echo "Chain ID: 8453 (Base)"
          echo "Dry Run: $DRY_RUN"
          echo "Scan Interval: ${SCAN_INTERVAL}ms"
      
      - name: Run TheWarden on Base Network
        env:
          DURATION: ${{ github.event.inputs.duration || '3600' }}
        run: |
          echo "ðŸš€ Starting TheWarden on Base Network"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "Chain: Base (8453)"
          echo "Duration: ${DURATION}s ($(($DURATION / 60)) minutes)"
          echo "Dry Run: ${{ github.event.inputs.dry_run || 'true' }}"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          
          # Run TheWarden with timeout
          timeout ${DURATION}s npm run start || {
            EXIT_CODE=$?
            if [ $EXIT_CODE -eq 124 ]; then
              echo "âœ… TheWarden completed scheduled run (timeout reached)"
            else
              echo "âš ï¸ TheWarden exited with code: $EXIT_CODE"
              exit $EXIT_CODE
            fi
          }
      
      - name: Analyze execution results
        if: always()
        run: |
          echo "ðŸ“Š Analyzing execution results..."
          
          # Check for log files
          if [ -f "logs/warden-output.log" ]; then
            echo "Latest log entries:"
            tail -50 logs/warden-output.log
            
            # Count opportunities found
            OPP_COUNT=$(grep -c "Found.*potential opportunities" logs/warden-output.log 2>/dev/null || echo "0")
            ERROR_COUNT=$(grep -c "ERROR" logs/warden-output.log 2>/dev/null || echo "0")
            
            echo ""
            echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
            echo "Execution Summary:"
            echo "  Opportunities Found: $OPP_COUNT"
            echo "  Errors: $ERROR_COUNT"
            echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          else
            echo "âš ï¸ No log file found"
          fi
      
      - name: Configure Git
        run: |
          git config --global user.name "TheWarden Bot"
          git config --global user.email "thewarden@autonomous.ai"
      
      - name: Commit and push execution logs
        run: |
          # Create execution summary
          TIMESTAMP=$(date -u +"%Y-%m-%d %H:%M:%S UTC")
          DRY_RUN="${{ github.event.inputs.dry_run || 'true' }}"
          DURATION="${{ github.event.inputs.duration || '3600' }}"
          
          # Create summary file
          SUMMARY_FILE=".memory/autonomous-execution/base_execution_$(date -u +%Y%m%d_%H%M%S).md"
          
          cat > "$SUMMARY_FILE" << 'SUMMARY_EOF'
# TheWarden Autonomous Base Network Execution

**Timestamp**: %TIMESTAMP%  
**Chain**: Base (8453)  
**Duration**: %DURATION%s (%DURATION_MIN% minutes)  
**Dry Run**: %DRY_RUN%  
**Workflow Run**: #${{ github.run_number }}

## Configuration
- Scan Interval: ${{ github.event.inputs.scan_interval || '800' }}ms
- Min Profit Threshold: 0.15%
- DEXes: Uniswap V2/V3, Aerodrome, BaseSwap

## Execution Results
SUMMARY_EOF
          
          # Replace placeholders
          DURATION_MIN=$(($DURATION / 60))
          sed -i "s/%TIMESTAMP%/$TIMESTAMP/g" "$SUMMARY_FILE"
          sed -i "s/%DURATION%/$DURATION/g" "$SUMMARY_FILE"
          sed -i "s/%DURATION_MIN%/$DURATION_MIN/g" "$SUMMARY_FILE"
          sed -i "s/%DRY_RUN%/$DRY_RUN/g" "$SUMMARY_FILE"
          
          # Add log summary if available
          if [ -f "logs/warden-output.log" ]; then
            echo "" >> "$SUMMARY_FILE"
            echo "### Log Summary" >> "$SUMMARY_FILE"
            echo '```' >> "$SUMMARY_FILE"
            tail -100 logs/warden-output.log >> "$SUMMARY_FILE"
            echo '```' >> "$SUMMARY_FILE"
          fi
          
          # Stage changes
          git add .memory/autonomous-execution/ || true
          git add logs/ || true
          
          # Check if there are changes to commit
          if git diff --staged --quiet; then
            echo "No new execution data to commit"
          else
            # Create commit message
            cat > /tmp/commit_msg.txt << 'COMMIT_EOF'
ðŸš€ Autonomous Base Network Execution - %TIMESTAMP%

Chain: Base (8453)
Duration: %DURATION_MIN% minutes
Dry Run: %DRY_RUN%

Generated by: autonomous-base-warden.yml
Workflow Run: #${{ github.run_number }}
COMMIT_EOF
            
            # Replace placeholders
            sed -i "s/%TIMESTAMP%/$TIMESTAMP/g" /tmp/commit_msg.txt
            sed -i "s/%DURATION_MIN%/$DURATION_MIN/g" /tmp/commit_msg.txt
            sed -i "s/%DRY_RUN%/$DRY_RUN/g" /tmp/commit_msg.txt
            
            git commit -F /tmp/commit_msg.txt --author="TheWarden Bot <thewarden@autonomous.ai>"
            git push
          fi
      
      - name: Upload execution logs
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: base-execution-logs-${{ github.run_number }}
          path: |
            logs/*.log
            .memory/autonomous-execution/*.md
          retention-days: 30
      
      - name: Notify on failure
        if: failure()
        run: |
          echo "::error::TheWarden autonomous execution on Base network failed"
          echo "Check the logs and workflow artifacts for details"
